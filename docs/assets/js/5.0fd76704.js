(window.webpackJsonp=window.webpackJsonp||[]).push([[5],{607:function(s,a,t){s.exports=t.p+"assets/img/image-20210414221202029.84a44a49.png"},608:function(s,a,t){s.exports=t.p+"assets/img/image-20210414221500618.61feacb7.png"},609:function(s,a,t){s.exports=t.p+"assets/img/image-20210414223549106.ce0671c9.png"},610:function(s,a,t){s.exports=t.p+"assets/img/image-20210414224733263.488cff6e.png"},611:function(s,a,t){s.exports=t.p+"assets/img/image-20210414225231928.552b0e05.png"},612:function(s,a,t){s.exports=t.p+"assets/img/image-20210414225514457.4a55150e.png"},613:function(s,a,t){s.exports=t.p+"assets/img/image-20210414225655785.b0f64025.png"},614:function(s,a,t){s.exports=t.p+"assets/img/image-20210414230024788.57b8891d.png"},615:function(s,a,t){s.exports=t.p+"assets/img/image-20210414231010180.56902ab9.png"},932:function(s,a,t){"use strict";t.r(a);var n=t(22),e=Object(n.a)({},(function(){var s=this,a=s.$createElement,n=s._self._c||a;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h1",{attrs:{id:"负载均衡策略-2"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#负载均衡策略-2"}},[s._v("#")]),s._v(" 负载均衡策略 2")]),s._v(" "),n("p",[s._v("上一节介绍了轮询和加权轮询，这章讲解另外几种：")]),s._v(" "),n("ul",[n("li",[s._v("ip_hash")]),s._v(" "),n("li",[s._v("hash")]),s._v(" "),n("li",[s._v("least_conn")])]),s._v(" "),n("h2",{attrs:{id:"ip-hash"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#ip-hash"}},[s._v("#")]),s._v(" ip_hash")]),s._v(" "),n("p",[n("img",{attrs:{src:t(607),alt:"image-20210414221202029"}})]),s._v(" "),n("p",[s._v("按访问 IP 做哈希算法，落到后端的服务节点上，也就是说如果该用户的 IP 一直不变，那么 ta 的请求将会一直落在同一个节点上")]),s._v(" "),n("p",[s._v("下面来看看 hash 算法是如何做的")]),s._v(" "),n("p",[n("img",{attrs:{src:t(608),alt:"image-20210414221500618"}})]),s._v(" "),n("blockquote",[n("p",[n("a",{attrs:{href:"http://nginx.org/en/docs/http/ngx_http_upstream_module.html#ip_hash",target:"_blank",rel:"noopener noreferrer"}},[s._v("官网文档"),n("OutboundLink")],1)])]),s._v(" "),n("div",{staticClass:"language-lua line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-lua"}},[n("code",[s._v("upstream "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("tomcats")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n   ip_hash"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n   server "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v(".56")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v(".106")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("8080")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n   server "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v(".56")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v(".107")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("8080")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n   server "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v(".56")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v(".108")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("8080")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])]),n("p",[s._v("这个 ip_hash 的源码在以下路径")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("/home/software/nginx-1.16.1/src/http/modules/ngx_http_upstream_ip_hash_module.c \n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("可以看看它的路径组织，在 modules 下，分模块放置的。它的源码里面写着 hash 的算法，只截取了 ip 地址的前 3 段进行计算，所以：如果你在同一个 IP 段中不同 IP 去访问的话，会被路由到同一台节点")]),s._v(" "),n("p",[n("img",{attrs:{src:t(609),alt:"image-20210414223549106"}})]),s._v(" "),n("p",[s._v("需要特别注意的是：当新增节点或删除节点的时候会 hash 值会变化，但是在临时移除节点的时候，可以使用 down 标记，可以让 hash 值不发生变化，如下所示")]),s._v(" "),n("div",{staticClass:"language-lua line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-lua"}},[n("code",[s._v("upstream "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("backend")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    ip_hash"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n    server backend1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("example"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    server backend2"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("example"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    server backend3"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("example"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com down"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    server backend4"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("example"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("h2",{attrs:{id:"hash-算法带来的问题"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#hash-算法带来的问题"}},[s._v("#")]),s._v(" hash 算法带来的问题")]),s._v(" "),n("p",[s._v("当节点数量变化后，hash 值计算后与原来的不一致，当大量用户和大量机器的时候，依赖该算法相关的业务都会受到一定的影响，比如缓存。")]),s._v(" "),n("p",[s._v("那么就有另外一种 hash 算法来解决这个问题：一致性哈希算法")]),s._v(" "),n("h2",{attrs:{id:"一致性哈希算法"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#一致性哈希算法"}},[s._v("#")]),s._v(" 一致性哈希算法")]),s._v(" "),n("p",[n("img",{attrs:{src:t(610),alt:"image-20210414224733263"}})]),s._v(" "),n("p",[s._v("一条线，上面分布着从 0 开始到 2"),n("sup",[s._v("32-1")]),s._v(" 的值，这条线可以变成一个圆圈")]),s._v(" "),n("p",[n("img",{attrs:{src:t(611),alt:"image-20210414225231928"}})]),s._v(" "),n("ol",[n("li",[s._v("计算机节点按照 hash 算法，分布在这个圆环上")]),s._v(" "),n("li",[s._v("那么用户计算访问时，它的 ip 经过 hash 算法后，也会落在这个圆环上的某一个点上")]),s._v(" "),n("li",[s._v("那么如果落在的不是在计算机节点上，就顺时针找到一个最近的节点")])]),s._v(" "),n("p",[s._v("如果节点减少，那么如下图所示：只会影响到 "),n("strong",[s._v("一部分")]),s._v(" 的用户被路由到下一个节点")]),s._v(" "),n("p",[n("img",{attrs:{src:t(612),alt:"image-20210414225514457"}})]),s._v(" "),n("p",[s._v("同理，增加节点的话，也只会影响到一部分的用户")]),s._v(" "),n("p",[n("img",{attrs:{src:t(613),alt:"image-20210414225655785"}})]),s._v(" "),n("h2",{attrs:{id:"url-hash"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#url-hash"}},[s._v("#")]),s._v(" url hash")]),s._v(" "),n("p",[s._v("基于 URL 的 hash 算法")]),s._v(" "),n("p",[n("img",{attrs:{src:t(614),alt:"image-20210414230024788"}})]),s._v(" "),n("p",[s._v("基于 URL 有一个问题：有可能某一个 URL 访问量很高，那么就会导致部分节点过热，部分节点过冷，这种情况下，可以让过热的节点上再做一个集群来分担压力")]),s._v(" "),n("blockquote",[n("p",[s._v("官方文档 "),n("a",{attrs:{href:"http://nginx.org/en/docs/http/ngx_http_upstream_module.html#hash",target:"_blank",rel:"noopener noreferrer"}},[s._v("hash"),n("OutboundLink")],1)])]),s._v(" "),n("p",[s._v("官方其实提供的是一个 hash 函数，用来计算 hash 的参数可以是任意值，这里我们使用内置变量获得 url 可以如下配置")]),s._v(" "),n("div",{staticClass:"language-hash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("upstream tomcats {\n   hash $request_uri;\n   \n   server 192.168.56.106:8080;\n   server 192.168.56.107:8080;\n   server 192.168.56.108:8080;\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("h2",{attrs:{id:"least-conn"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#least-conn"}},[s._v("#")]),s._v(" least_conn")]),s._v(" "),n("p",[s._v("根据最少连接数路由")]),s._v(" "),n("p",[n("img",{attrs:{src:t(615),alt:"image-20210414231010180"}})]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("upstream tomcats "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n   least_conn"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n   \n   server "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".56.106:8080"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n   server "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".56.107:8080"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n   server "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".56.108:8080"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])])])}),[],!1,null,null,null);a.default=e.exports}}]);